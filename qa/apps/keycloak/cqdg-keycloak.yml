apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: keycloak
spec:
  template:
    spec:
      imagePullSecrets:
      - name: images-pull
      containers:
      - name: keycloak
        image: index.docker.io/ferlabcrsj/cqdg-keycloak:62fd836a4ac952a7787102c418ddd4ed7ff843a5-1695908311 # {"$imagepolicy": "cqdg-qa-fluxcd:keycloak"}
        env:
        - name: HOME_URL
          value: 'https://portal.qa.cqdg.ferlab.bio'
        - name: DOCS_URL
          value: 'https://docs.qa.cqdg.ferlab.bio'
        - name: ORCID_URL
          value: 'https://sandbox.orcid.org'
        - name: REACT_APP_USERS_API_URL
          value: 'https://users.qa.cqdg.ferlab.bio'
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: postgres-qa-keycloak-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-qa-keycloak-credentials
              key: password
        - name: DB_VENDOR
          value: postgres
        - name: DB_ADDR
          value: postgres-server-blue-qa
        - name: DB_PORT
          value: "5432"
        - name: DB_DATABASE
          value: keycloak_qa
        - name: JDBC_PARAMS
          value: 'sslmode=verify-full&sslrootcert=/opt/ca/ca.pem'
        volumeMounts:
        - name: ca-certificate
          mountPath: /opt/ca
          readOnly: true
      volumes:
      - name: ca-certificate
        secret:
          secretName: postgres-qa-ca-certificate
          defaultMode: 0555
