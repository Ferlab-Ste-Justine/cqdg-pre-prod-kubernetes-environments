
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: postgres-blue-configuration
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 15
  jobTemplate:
    spec:
      activeDeadlineSeconds: 300
      backoffLimit: 0
      template:
        spec:
          imagePullSecrets:
            - name: images-pull
          restartPolicy: Never
          volumes:
            - name: github-credentials
              secret:
                secretName: postgres-configs-repo-access-key
                defaultMode: 0400
            - name: terraform-backend
              secret:
                secretName: postgres-blue-configs-terraform-backend
                defaultMode: 0400
            - name: terracd-configuration
              configMap:
                name: postgres-blue-configuration-terracd-configs
                defaultMode: 0555
            - name: db-ca-certificate
              secret:
                secretName: postgres-qa-ca-certificate
                defaultMode: 0555
          containers:
            - image: ferlabcrsj/terracd:0.7.0
              name: postgres-blue-configuration
              envFrom:
                - secretRef:
                    name: postgres-blue-configs-terraform-variables
              env:
                - name: TERRACD_CONFIG_FILE
                  value: /opt/terracd-configuration/config.yml
              volumeMounts:
                - name: github-credentials
                  mountPath: /opt/github-ssh
                - name: terraform-backend
                  mountPath: /opt/backend
                - name: terracd-configuration
                  mountPath: /opt/terracd-configuration
                - name: db-ca-certificate
                  mountPath: /opt/postgres-ca
                  readOnly: true