apiVersion: apps/v1
kind: Deployment
metadata:
  name: datagrid-service
spec:
  template:
    spec:
      imagePullSecrets:
      - name: images-pull
      volumes:
      - name: postgres-ca-certificate
        secret:
          secretName: postgres-qa-ca-certificate
          defaultMode: 0555
      - name: ingress-ca-certificate
        secret:
          secretName: cqdg-ingress-ca-certificate
          defaultMode: 0555
      - name: ca-bundle
        emptyDir: {}
      - name: corefile
        configMap:
          name: coredns-zonefiles-corefile
          defaultMode: 0444
      - name: zonefile
        configMap:
          name: qa-domain-zonefile
          defaultMode: 0444
      - name: zonefile-copy
        emptyDir: {}
      dnsPolicy: None
      dnsConfig:
        nameservers:
        - 127.0.0.1
        searches:
        - search
        - cqdg-qa.svc.cluster.qa
        - svc.cluster.qa
        - cluster.qa
        - openstacklocal
        options:
        - name: ndots
          value: "5"
      initContainers:
      - name: copy-zonefile
        image: alpine:3.13.6
        command: ["sh"]
        args: ["-c", "cp /opt/zonefiles/* /opt/zonefiles-copy/"]
        volumeMounts:
        - name: zonefile
          mountPath: /opt/zonefiles
          readOnly: true
        - name: zonefile-copy
          mountPath: /opt/zonefiles-copy
      - name: ca-bundler
        image: alpine:3.13.6
        command: ["sh"]
        args: ["-c", "cat /opt/postgres-ca/ca.pem /opt/ingress-ca/ca.pem > /opt/ca-bundle/ca.pem"]
        volumeMounts:
        - name: postgres-ca-certificate
          mountPath: /opt/postgres-ca
          readOnly: true
        - name: ingress-ca-certificate
          mountPath: /opt/ingress-ca
          readOnly: true
        - name: ca-bundle
          mountPath: /opt/ca-bundle
      containers:
      - name: coredns
        image: ferlabcrsj/coredns:1.1.1
        command: ["/coredns"]
        args: ["-conf", "/opt/corefile/Corefile"]
        volumeMounts:
        - name: corefile
          mountPath: /opt/corefile
          readOnly: true
        - name: zonefile-copy
          mountPath: /opt/zonefiles
          readOnly: true
      - name: datagrid-service
        image: index.docker.io/ferlabcrsj/datagrid-service:a6afb414748c3eea21110aaf2075732573282f1e-1679589502 # {"$imagepolicy": "cqdg-qa-fluxcd:datagrid-service"}
        env:
        - name: PGUSER
          valueFrom:
            secretKeyRef:
              name: postgres-qa-datagrid-service-credentials
              key: username
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-qa-datagrid-service-credentials
              key: password
        envFrom:
        - configMapRef:
            name: datagrid-service-db-connection
        - configMapRef:
            name: datagrid-service-db-connection-tls
        - configMapRef:
            name: datagrid-service-keycloak-access
        - configMapRef:
            name: datagrid-service-customizations
        volumeMounts:
        - name: postgres-ca-certificate
          mountPath: /opt/ca
          readOnly: true
        - name: ca-bundle
          mountPath: /opt/ca-bundle
          readOnly: true
