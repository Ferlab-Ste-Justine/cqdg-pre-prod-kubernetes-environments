
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: keycloak-configuration
spec:
  schedule: "*/1 * * * *"
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 15
  jobTemplate:
    spec:
      activeDeadlineSeconds: 300
      backoffLimit: 0
      template:
        spec:
          imagePullSecrets:
            - name: images-pull
          restartPolicy: Never
          volumes:
            - name: github-credentials
              secret:
                secretName: keycloak-configs-repo-access-key
                defaultMode: 0400
            - name: terraform-backend
              secret:
                secretName: keycloak-configs-terraform-backend
                defaultMode: 0400
            - name: terraform-provider
              secret:
                secretName: keycloak-configs-terraform-provider
                defaultMode: 0400
            - name: terracd-configuration
              configMap:
                name: keycloak-configuration-terracd-configs
                defaultMode: 0555
            - name: ingress-ca-certificate
              secret:
                secretName: cqdg-ingress-ca-certificate
                defaultMode: 0555
            - name: entrypoint
              configMap:
                name: keycloak-configuration-entrypoint
                defaultMode: 0555
          containers:
            - image: ferlabcrsj/terracd:0.5.0
              name: keycloak-configuration
              command: ["/opt/entrypoint/entrypoint.sh"]
              envFrom:
                - secretRef:
                    name: keycloak-configs-terraform-variables
              env:
                - name: TERRACD_CONFIG_FILE
                  value: /opt/terracd-configuration/config.yml
                - name: GODEBUG
                  value: "x509ignoreCN=0"
              volumeMounts:
                - name: github-credentials
                  mountPath: /opt/github-ssh
                - name: terraform-backend
                  mountPath: /opt/backend
                - name: terraform-provider
                  mountPath: /opt/provider
                - name: terracd-configuration
                  mountPath: /opt/terracd-configuration
                - name: ingress-ca-certificate
                  mountPath: /opt/ingress-ca
                - name: entrypoint
                  mountPath: /opt/entrypoint