apiVersion: apps/v1
kind: Deployment
metadata:
  name: sftp-server
  namespace: cqdg-qa
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sftp-server
  template:
    metadata:
      labels:
        app: sftp-server
    spec:
      initContainers:
      - name: init-sftp
        image: busybox
        volumeMounts:
        - name: sftp-data
          mountPath: /home
        command: ['sh', '-c', 'mkdir -p /home/admin /home/user1 /home/user2 /home/admin/shared /home/user1/shared /home/user2/shared && chown 1000:1000 /home/admin && chown 1001:1001 /home/user1 && chown 1002:1002 /home/user2']
      containers:
      - name: sftp
        image: atmoz/sftp
        ports:
        - containerPort: 22
        volumeMounts:
        - mountPath: /home
          name: sftp-data
        env:
        - name: SFTP_USERS
          value: "admin:pass:1000:1000::/home/admin/shared;user1:pass:1001:1001::/home/user1/shared;user2:pass:1002:1002::/home/user2/shared"
      volumes:
      - name: sftp-data
        persistentVolumeClaim:
          claimName: sftp-pvc
